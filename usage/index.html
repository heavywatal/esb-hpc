<!doctype html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>Usage - Metal — HPC cluster of ESB, SOKENDAI</title>
<link rel="stylesheet" href="/restricted_access/esb-hpc/css/theme.css">
<link rel="apple-touch-icon" sizes="180x180" href="/restricted_access/esb-hpc/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/restricted_access/esb-hpc/favicon-32x32.png" sizes="32x32">
<link rel="manifest" href="/restricted_access/esb-hpc/manifest.json">
<meta name="theme-color" content="#1a4694">
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="Usage">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost/restricted_access/esb-hpc/usage/">
<meta property="og:image" content="">
<meta property="og:description" content="">
<meta property="og:site_name" content="Metal — HPC cluster of ESB, SOKENDAI">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="">
<meta name="twitter:creator" content="">
<meta name="generator" content="Hugo 0.56.0-DEV" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js" integrity="sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-ukiibbYjFS/1dhODSWD+PrZ6+CGCgf8VbyUH7bQQNUulL+2r59uGYToovytTf4Xm" crossorigin="anonymous"></script>

</head>
<body>
<header><h1><a href="/restricted_access/esb-hpc/">
<img class="logo" src="/restricted_access/esb-hpc/sokendai-logomark.svg" alt="sokendai-logomark.svg">
Metal — HPC cluster of ESB, SOKENDAI
</a></h1>
</header>
<main>
<article>
<header><h1><a href="/restricted_access/esb-hpc/usage/">
Usage
</a></h1>
<nav class="tags"><ul>
</ul></nav>
</header>

<h2 id="getting-started">Getting Started</h2>

<ol>
<li>Read through all the pages in this document.</li>
<li><a href="/restricted_access/esb-hpc/usage/#how-to-setup-ssh-keys">Prepare an SSH key pair on your local computer</a>.</li>
<li>Complete <a href="https://goo.gl/forms/kxe6AWalGjH4wg5t2">the online registration form</a>.</li>
<li>Accept the invitation to <a href="https://groups.google.com/forum/#!forum/metal-sokendai">the user mailing list</a>.</li>
<li>Login to the server: <code>ssh &lt;USERNAME&gt;@metal.campus.soken.ac.jp</code></li>
</ol>

<h2 id="notes">Notes</h2>

<ul>
<li>Access:

<ul>
<li>Feel free to post any question and request to
<a href="https://groups.google.com/forum/#!forum/metal-sokendai">the mailing list</a>.
It will help other users and improving this document.
Do NOT contact the administrators personally.</li>
<li>No graphical user interface (GUI) is available;
all the operation has to be carried out with a <strong>command-line interface (CLI)</strong> over <strong>SSH</strong> connection.
Basic knowledge of shell scripting is required.</li>
<li>The server is accessible <strong>only from the ESB campus LAN</strong>.</li>
</ul></li>
<li>Data Storage:

<ul>
<li><strong>100GB</strong> disk space is allocated for each user.
The size may be changed in the future.</li>
<li><strong>Do NOT think this system as a long-term storage service</strong>.
Transfer output data to your local computer,
and delete them from the server immediately after each job execution.
Or, at least, always keep your data deletable on the server.</li>
<li>It is recommended to use <a href="https://www.google.co.jp/search?q=rsync+ssh"><strong>rsync</strong></a>
to transfer/synchronize your files between your local computer and the server.
<a href="https://git-scm.com/"><strong>Git</strong></a> is also useful to manage your scripts.</li>
<li>Your home directory <code>~/</code> on the head node is shared with the compute nodes.
You don&rsquo;t have to care about data transfer between nodes within the system.</li>
</ul></li>
<li>Job execution:

<ul>
<li><strong>Do NOT execute programs directly on the head node</strong>.
All the computational tasks must be managed by the PBS job scheduler
<a href="#pbs-job-scheduler">(as detailed below)</a>.
Very small tasks in the following examples are the exceptions,
i.e., you can execute only these commands on the head node:

<ul>
<li>Basic shell operation: <code>pwd</code>, <code>cd</code>, <code>ls</code>, <code>cat</code>, <code>mv</code>, <code>rm</code>, etc.</li>
<li>File transfer: <code>rsync</code>, <code>git</code>, etc.</li>
<li>Text editor: <code>vim</code>, <code>emacs</code>, <code>nano</code>, etc.</li>
<li>Compilation/installation of a small program:
<code>gcc</code>, <code>make</code>, <code>cmake</code>, <code>pip</code>, etc.</li>
<li>PBS command: <code>pbsnodes</code>, <code>qstat</code>, <code>qsub</code>, etc.</li>
</ul></li>
<li>Check <a href="/restricted_access/esb-hpc/software/">the list of available softwares</a>.
You can install additional softwares into your home directory,
or ask the administrator for system-wide installation.</li>
</ul></li>
</ul>

<h2 id="how-to-setup-ssh-keys">How to setup SSH keys</h2>

<ol>
<li><p>Execute the following command on your local computer:</p>

<pre><code>ssh-keygen -t ed25519 -N ''
</code></pre>

<p>Press <kbd>return</kbd> to accept the default name of the key file:</p>

<pre><code>Generating public/private ed25519 key pair.
Enter file in which to save the key (~/.ssh/id_ed25519): # return
Your identification has been saved in ~/.ssh/id_ed25519.
Your public key has been saved in ~/.ssh/id_ed25519.pub.
</code></pre></li>

<li><p>Check the created keys:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">ls -al ~/.ssh
<span class="c1"># drwx------ 11 winston staff 374 Apr 04 10:00 ./</span>
<span class="c1"># -rw-------  1 winston staff 399 Apr 04 10:00 id_ed25519</span>
<span class="c1"># -rw-r--r--  1 winston staff  92 Apr 04 10:00 id_ed25519.pub</span></code></pre></div>
<p>The permissions of <code>~/.ssh</code> and <code>~/.ssh/id_ed25519</code> must be <code>700</code> and <code>600</code>, respectively.</p></li>

<li><p>Copy and paste the whole content of the public key (<strong>NOT</strong> private key) to
<a href="https://goo.gl/forms/kxe6AWalGjH4wg5t2">the online registration form</a>.
For example, <code>pbcopy</code> command is useful on macOS:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">cat ~/.ssh/id_ed25519.pub <span class="p">|</span> pbcopy</code></pre></div></li>

<li><p>After the administrator adds your public key to your <code>~/.ssh/authorized_keys</code> on the server,
you can login from the local computer with the private key <code>~/.ssh/id_ed25519</code>.</p>

<pre><code>ssh your_username_on_metal@metal.campus.soken.ac.jp
</code></pre></li>

<li><p>(Optional) Create <code>~/.ssh/config</code> on your local computer:</p>

<pre><code>Host metal
  Hostname metal.campus.soken.ac.jp
  User your_username_on_metal
</code></pre>

<p>Then you can login with the shorter command: <code>ssh metal</code>.</p></li>
</ol>

<h2 id="pbs-job-scheduler">PBS job scheduler</h2>

<p>Read <a href="https://www.google.co.jp/search?q=pbs+professional+14">PBS User&rsquo;s Guide</a>.</p>

<h3 id="check-ths-system-status">Check ths system status</h3>

<pre><code>pbsnodes -aSj
</code></pre>

<h3 id="check-the-status-of-jobs">Check the status of jobs</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># List</span>
qstat -x

<span class="c1"># See the detail of a job</span>
qstat -fx &lt;PBS_JOBID&gt;</code></pre></div>
<h3 id="delete-a-job">Delete a job</h3>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">qdel &lt;PBS_JOBID&gt;</code></pre></div>
<h3 id="submit-a-job">Submit a job</h3>

<p>You can submit a job from command line or by using scripts:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">qsub -N jobname -j oe -- /path/to/your/executable <span class="o">[</span>args...<span class="o">]</span>
    <span class="c1"># or</span>
qsub hello.sh</code></pre></div>
<p>An example job script <code>hello.sh</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1">#PBS -N hello-world</span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -l select=1:ncpus=1:mem=1gb</span>

<span class="nb">pwd</span>
<span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>
<span class="nb">pwd</span>
<span class="nb">echo</span> <span class="s2">&#34;Hello, world!&#34;</span>
sleep <span class="m">60</span></code></pre></div>
<p>An example of an array job <code>array.sh</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1">#PBS -N array-ms</span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -l select=1:ncpus=1:mem=1gb</span>
<span class="c1">#PBS -J 0-3</span>

<span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>
<span class="nv">param_range</span><span class="o">=(</span><span class="k">$(</span>seq <span class="m">5</span>.0 <span class="m">0</span>.5 <span class="m">6</span>.5<span class="k">)</span><span class="o">)</span>  <span class="c1"># (5.0, 5.5, 6.0, 6.5)</span>
<span class="nv">theta</span><span class="o">=</span><span class="si">${</span><span class="nv">param_range</span><span class="p">[@]:</span><span class="si">${</span><span class="nv">PBS_ARRAY_INDEX</span><span class="si">}</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span>
ms <span class="m">4</span> <span class="m">2</span> -t <span class="nv">$theta</span></code></pre></div>
<p>An equivalent job script in Python:</p>
<div class="highlight"><pre class="chroma"><code class="language-py" data-lang="py"><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">#PBS -N array-ms-py</span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -l select=1:ncpus=1:mem=1gb</span>
<span class="c1">#PBS -J 0-3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PBS_O_WORKDIR&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
<span class="n">array_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PBS_ARRAY_INDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
<span class="n">param_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># [5.0, 5.5, 6.0, 6.5]</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">param_range</span><span class="p">[</span><span class="n">array_index</span><span class="p">]</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;ms 4 2 -t {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code></pre></div>
<p>Useful options and environment variables:</p>

<dl>
<dt><code>-N job_name</code></dt>
<dd>to set job&rsquo;s name.</dd>
<dt><code>-o ***</code>, <code>-e ***</code></dt>
<dd>to specify the path for the standard output/error stream.
By default, they are writen to the current working directory where <code>qsub</code> was executed,
i.e., <code>${PBS_O_WORKDIR}/${PBS_JOBNAME}.o&lt;sequence_number&gt;</code></dd>
<dt><code>-j oe</code></dt>
<dd>to merge the standard error stream into the standard output stream.
It is equivalent to <code>2&gt;&amp;1</code> in shell redirection.</dd>
<dt><code>-J 0-3</code></dt>
<dd>to declare the job is an array job (with size 4 in this example).
A current index (<code>0</code>, <code>1</code>, &hellip;) can be obtained via <code>PBS_ARRAY_INDEX</code>.</dd>
<dt><code>-l ***</code></dt>
<dd>to request resources.</dd>
<dt><code>-v VARIABLE=value</code></dt>
<dd>to export environment variables to the job.</dd>
<dt><code>PBS_JOBID</code></dt>
<dd>the ID of the job.</dd>
<dt><code>PBS_JOBNAME</code></dt>
<dd>the name of the job.</dd>
<dt><code>PBS_O_WORKDIR</code></dt>
<dd>the working directory where <code>qsub</code> was called.
By default, stdout/stderr are copied to here,
although jobs are executed in <code>$HOME</code>.
You may want to <code>cd $PBS_O_WORKDIR</code> in many cases.</dd>
</dl>

<p>See <code>man qsub</code> for more details.</p>
</article>
</main>

<nav class="menu">

<div><a href="/restricted_access/esb-hpc/">Home</a></div>

<div class="active"><a href="/restricted_access/esb-hpc/usage/">Usage</a></div>

<div><a href="/restricted_access/esb-hpc/hardware/">Hardware</a></div>

<div><a href="/restricted_access/esb-hpc/software/">Software</a></div>
</nav>
<footer><small></small></footer>
</body>
</html>
